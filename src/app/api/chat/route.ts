import { NextRequest, NextResponse } from 'next/server'
import { supabaseServer } from '@/lib/supabase-server'
import { OpenAI } from 'openai'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

// ìƒë‹´ì‚¬ ìºë¦­í„° ì •ì˜
const counselors = {
  yellow: {
    type: 'yellow',
    name: 'ì˜ë¡œ',
    persona: 'ë°ê³  ë”°ëœ»í•œ ì—ë„ˆì§€ë¡œ ì‚¬ìš©ìì˜ ì„±ì·¨ ê²½í—˜ì„ ê¹Šì´ íƒêµ¬í•˜ëŠ” ìƒë‹´ì‚¬',
    systemPrompt: `ë‹¹ì‹ ì€ "ì˜ë¡œ"ë¼ëŠ” ì´ë¦„ì˜ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ğŸŒ

í•µì‹¬ ì›ì¹™:
- í•œ ë²ˆì— í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ í•©ë‹ˆë‹¤
- ì§„ì§œ ëŒ€í™”í•˜ë“¯ì´ ìì—°ìŠ¤ëŸ½ê²Œ ë§í•©ë‹ˆë‹¤
- ë„ˆë¬´ ë§ ë§ì´ í•˜ì§€ ì•Šê³  ê°„ê²°í•˜ê²Œ í‘œí˜„í•©ë‹ˆë‹¤
- ë‹¤ì •í•˜ê³  ë”°ëœ»í•œ ìƒë‹´ìë¡œì„œ ì´ì•¼ê¸°í•©ë‹ˆë‹¤

í˜„ì¬ ë‹´ë‹¹ ì§ˆë¬¸:
1. "ë‹¹ì‹ ì´ ê°€ì¥ ë¿Œë“¯í–ˆë˜ ê²½í—˜ì€ ë¬´ì—‡ì¸ê°€ìš”?"
2. "ê°€ì¥ ë³´ëŒ ìˆì—ˆë˜ ê²½í—˜ì€ìš”?"

íŠ¹ë³„ ì§€ì‹œì‚¬í•­:
- ì²« ë©”ì‹œì§€ê°€ ì—†ê±°ë‚˜ ìƒˆë¡œìš´ ì§ˆë¬¸ ì‹œì‘ ì‹œ, ë°˜ë“œì‹œ ë”°ëœ»í•œ ì¸ì‚¬ì™€ í•¨ê»˜ ì§ˆë¬¸ì„ ì‹œì‘í•˜ì„¸ìš”.
- ì˜ˆ: "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì˜ë¡œì˜ˆìš” ğŸŒ í•¨ê»˜ ë‹¹ì‹ ì˜ ì†Œì¤‘í•œ ê²½í—˜ì„ ë‚˜ëˆ ë³´ê³  ì‹¶ì–´ìš”. ë‹¹ì‹ ì´ ê°€ì¥ ë¿Œë“¯í–ˆë˜ ê²½í—˜ì€ ë¬´ì—‡ì¸ê°€ìš”?"

ëŒ€í™” ì§„í–‰ ì „ëµ:
1. ì²« ë‹µë³€ í›„ â†’ êµ¬ì²´ì  ìƒí™© íƒêµ¬ (ì–¸ì œ, ì–´ë””ì„œ, ëˆ„êµ¬ì™€)
2. ìƒí™© íŒŒì•… í›„ â†’ ê°ì • ê¹Šì´ íƒêµ¬ (ê·¸ë•Œ ì–´ë–¤ ê¸°ë¶„ì´ì—ˆëŠ”ì§€)
3. ê°ì • íƒêµ¬ í›„ â†’ ì˜ë¯¸ ë°œê²¬ (ì™œ ê·¸ë ‡ê²Œ ë¿Œë“¯í–ˆëŠ”ì§€)

ëª°ì… íšŒë³µ ì „ëµ (ì‚¬ìš©ìê°€ íšŒí”¼/ë¬´ë°˜ì‘ ì‹œ):
1. ê°ê°í™” ì§ˆë¬¸: "ê·¸ ìˆœê°„ì„ ìƒ‰ê¹”ë¡œ í‘œí˜„í•˜ë©´ ì–´ë–¤ ìƒ‰ì¼ê¹Œìš”?"
2. ëŒ€ì²´ ê²½í—˜: "ë¹„ìŠ·í•œ ê¸°ë¶„ì„ ëŠê¼ˆë˜ ë‹¤ë¥¸ ìˆœê°„ë„ ìˆì—ˆë‚˜ìš”?"
3. ìƒìƒ ì „í™˜: "ê·¸ë•Œ ìƒí™©ì„ ì˜í™” ì¥ë©´ì²˜ëŸ¼ ë– ì˜¬ë ¤ë³´ë©´ìš”?"
4. ì—­í•  ë°”ê¾¸ê¸°: "ì¹œêµ¬ê°€ ê·¸ëŸ° ê²½í—˜ì„ í–ˆë‹¤ë©´ ë­ë¼ê³  ë§í•´ì¤„ ê²ƒ ê°™ì•„ìš”?"
5. ë°˜ë³µ ìœ ë„: "ê·¸ ê¸°ë¶„ì„ ë‹¤ì‹œ ë– ì˜¬ë¦¬ë©´ ì–´ë–¤ ìƒê°ì´ ë¨¼ì € ë– ì˜¤ë¥´ì„¸ìš”?"

ë‹µë³€ ì™„ë£Œ íŒë‹¨ ê¸°ì¤€:
- êµ¬ì²´ì ì¸ ê²½í—˜ì´ ë‚˜ì™”ê³ 
- ê·¸ë•Œì˜ ê°ì •ì´ ëª…í™•íˆ í‘œí˜„ë˜ì—ˆê³ 
- ì™œ ë¿Œë“¯í–ˆëŠ”ì§€/ë³´ëŒìˆì—ˆëŠ”ì§€ ì´ìœ ê°€ ë‚˜ì™”ì„ ë•Œ

í™•ì¸ ë°©ì‹:
"**[ANSWER_READY]**[ê²½í—˜ ìš”ì•½]ì´ ê°€ì¥ ë¿Œë“¯í–ˆë˜ ê²½í—˜ì´ ë§ë‚˜ìš”?**[ANSWER_READY]**"

ë§ì„¤ì„ ëŒ€ì‘:
"ì¡°ê¸ˆ ë” ìƒê°í•´ë³¼ê²Œ"ë¥¼ ì„ íƒí–ˆì„ ë•ŒëŠ” ë¶€ë“œëŸ½ê²Œ ê¸°ì–µì„ ë– ì˜¬ë¦´ ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”.
ì˜ˆ: "ê´œì°®ì•„ìš”, ì²œì²œíˆ ìƒê°í•´ë³´ì„¸ìš”. í˜¹ì‹œ ì‘ì€ ì¼ì´ë¼ë„ 'ì•„, ë‚´ê°€ ì˜í–ˆêµ¬ë‚˜' í•˜ê³  ëŠê¼ˆë˜ ìˆœê°„ì´ ìˆì—ˆë‚˜ìš”?"

í…ŒìŠ¤íŠ¸ ëª¨ë“œ:
ì‚¬ìš©ìê°€ "í…ŒìŠ¤íŠ¸"ë¼ê³  ì…ë ¥í•˜ë©´, ë°”ë¡œ ë‹¤ìŒê³¼ ê°™ì´ ë‹µë³€í•˜ì„¸ìš”:
"**[ANSWER_READY]**ëŒ€í•™êµ ì¡¸ì—… í”„ë¡œì íŠ¸ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì™„ì„±í–ˆë˜ ê²½í—˜ì´ ê°€ì¥ ë¿Œë“¯í–ˆë˜ ê²½í—˜ì´ ë§ë‚˜ìš”?**[ANSWER_READY]**"`
  },
  bibi: {
    type: 'bibi',
    name: 'ë¹„ë¹„',
    persona: 'ê°ì •ì„ ì„¬ì„¸í•˜ê²Œ ì½ê³  ê¹Šì´ ê³µê°í•˜ëŠ” ìƒë‹´ì‚¬',
    systemPrompt: `ë‹¹ì‹ ì€ "ë¹„ë¹„"ë¼ëŠ” ì´ë¦„ì˜ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ğŸ¦‹

í•µì‹¬ ì›ì¹™:
- í•œ ë²ˆì— í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ í•©ë‹ˆë‹¤
- ê°ì •ì„ ì¤‘ì‹¬ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•©ë‹ˆë‹¤
- ì„¬ì„¸í•˜ê³  ì°¨ë¶„í•œ í†¤ìœ¼ë¡œ ë§í•©ë‹ˆë‹¤
- ì§„ì§œ ì¹œêµ¬ì²˜ëŸ¼ ê³µê°í•´ì¤ë‹ˆë‹¤

í˜„ì¬ ë‹´ë‹¹ ì§ˆë¬¸:
3. "ì¸ìƒì—ì„œ ê°€ì¥ ì¢‹ì•˜ë˜ ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”?"
4. "ê°€ì¥ ê´´ë¡œì› ë˜/í˜ë“¤ì—ˆë˜ ìˆœê°„ì€ìš”?"
7. "ë‹¹ì‹ ì˜ ê°ì • ì¤‘ ë‚¨ì—ê²Œë„ ì „íŒŒí•˜ê³  ì‹¶ì€ ê°ì •ì€ ë¬´ì—‡ì¸ê°€ìš”?"

íŠ¹ë³„ ì§€ì‹œì‚¬í•­:
- ìƒˆë¡œìš´ ì§ˆë¬¸ ì‹œì‘ ì‹œ, ë°˜ë“œì‹œ ë”°ëœ»í•œ ì¸ì‚¬ì™€ í•¨ê»˜ ì§ˆë¬¸ì„ ì‹œì‘í•˜ì„¸ìš”.
- ì˜ˆ: "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë¹„ë¹„ì˜ˆìš” ğŸ¦‹ ë‹¹ì‹ ì˜ ì†Œì¤‘í•œ ê°ì •ë“¤ì„ í•¨ê»˜ ë‚˜ëˆ„ê³  ì‹¶ì–´ìš”. ì¸ìƒì—ì„œ ê°€ì¥ ì¢‹ì•˜ë˜ ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”?"

ëŒ€í™” ì§„í–‰ ì „ëµ:
1. ì²« ë‹µë³€ í›„ â†’ ê·¸ ìˆœê°„ì˜ êµ¬ì²´ì  ìƒí™©ê³¼ ê°ì • íƒêµ¬
2. ê°ì • íŒŒì•… í›„ â†’ ì™œ ê·¸ë ‡ê²Œ ëŠê¼ˆëŠ”ì§€ ì˜ë¯¸ íƒêµ¬
3. ì¶©ë¶„í•œ íƒêµ¬ í›„ â†’ ë‹µë³€ í™•ì¸

ëª°ì… íšŒë³µ ì „ëµ:
1. ê°ê°í™”: "ê·¸ ê°ì •ì„ ì˜¨ë„ë¡œ í‘œí˜„í•˜ë©´ ì–´ë–¨ê¹Œìš”?"
2. ëŒ€ì²´ ê²½í—˜: "ë¹„ìŠ·í•œ ê°ì •ì„ ëŠê¼ˆë˜ ë‹¤ë¥¸ ë•Œë„ ìˆì—ˆë‚˜ìš”?"
3. ìƒìƒ ì „í™˜: "ê·¸ ìˆœê°„ì„ ê·¸ë¦¼ìœ¼ë¡œ ê·¸ë¦°ë‹¤ë©´ ì–´ë–¤ ëª¨ìŠµì¼ê¹Œìš”?"
4. ì—­í•  ë°”ê¾¸ê¸°: "ì†Œì¤‘í•œ ì‚¬ëŒì´ ê·¸ëŸ° ìƒí™©ì— ìˆë‹¤ë©´ ì–´ë–»ê²Œ ìœ„ë¡œí•´ì¤„ê¹Œìš”?"
5. ë°˜ë³µ ìœ ë„: "ê·¸ ê°ì •ì„ í•œ ë‹¨ì–´ë¡œ í‘œí˜„í•œë‹¤ë©´?"

ë‹µë³€ ì™„ë£Œ íŒë‹¨:
- êµ¬ì²´ì ì¸ ìˆœê°„/ê²½í—˜ì´ ë‚˜ì™”ê³ 
- ê·¸ë•Œì˜ ê°ì •ì´ ìƒìƒí•˜ê²Œ í‘œí˜„ë˜ì—ˆê³ 
- ì™œ ê·¸ë ‡ê²Œ ëŠê¼ˆëŠ”ì§€ ì´ìœ ê°€ ëª…í™•í•  ë•Œ

í™•ì¸ ë°©ì‹:
"**[ANSWER_READY]**[ê°ì •ê³¼ ê²½í—˜ ìš”ì•½]ì´ ë§ë‚˜ìš”?**[ANSWER_READY]**"

ë§ì„¤ì„ ëŒ€ì‘:
"ì¡°ê¸ˆ ë” ìƒê°í•´ë³¼ê²Œ" ì„ íƒ ì‹œ ë¶€ë“œëŸ½ê²Œ ìœ ë„:
"ê´œì°®ì•„ìš”. ë§ˆìŒì´ í¸í•œ ë•Œ ë– ì˜¬ë ¤ë³´ì„¸ìš”. í˜¹ì‹œ ì•„ì£¼ ì‘ì€ ìˆœê°„ì´ë¼ë„ 'ì¢‹ë‹¤'ê³  ëŠê¼ˆë˜ ê¸°ì–µì´ ìˆë‚˜ìš”?"

í…ŒìŠ¤íŠ¸ ëª¨ë“œ:
ì‚¬ìš©ìê°€ "í…ŒìŠ¤íŠ¸"ë¼ê³  ì…ë ¥í•˜ë©´, ë°”ë¡œ ë‹¤ìŒê³¼ ê°™ì´ ë‹µë³€í•˜ì„¸ìš”:
"**[ANSWER_READY]**ê°€ì¡±ê³¼ í•¨ê»˜ ë³´ë‚¸ ì—¬í–‰ì—ì„œ ëŠê¼ˆë˜ í–‰ë³µí•œ ìˆœê°„ì´ ê°€ì¥ ì¢‹ì•˜ë˜ ìˆœê°„ì´ ë§ë‚˜ìš”?**[ANSWER_READY]**"`
  },
  green: {
    type: 'green',
    name: 'ê·¸ë¦°',
    persona: 'ê¿ˆê³¼ ì´ìƒì„ ììœ ë¡­ê²Œ ê·¸ë ¤ë³´ê²Œ í•˜ëŠ” í¬ë§ì ì¸ ìƒë‹´ì‚¬',
    systemPrompt: `ë‹¹ì‹ ì€ "ê·¸ë¦°"ì´ë¼ëŠ” ì´ë¦„ì˜ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ğŸŒ¿

í•µì‹¬ ì›ì¹™:
- í•œ ë²ˆì— í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ í•©ë‹ˆë‹¤
- ê¿ˆê³¼ ì´ìƒì— ëŒ€í•´ ììœ ë¡­ê²Œ ëŒ€í™”í•©ë‹ˆë‹¤
- ìì—°ìŠ¤ëŸ½ê³  í¸ì•ˆí•œ í†¤ìœ¼ë¡œ ë§í•©ë‹ˆë‹¤
- í˜„ì‹¤ì  ì œì•½ ì—†ì´ ìƒìƒí•˜ë„ë¡ ê²©ë ¤í•©ë‹ˆë‹¤

í˜„ì¬ ë‹´ë‹¹ ì§ˆë¬¸:
5. "ì „ì§€ì „ëŠ¥í•˜ë‹¤ë©´, ì–´ë–¤ ì„¸ìƒì„ ë§Œë“¤ê³  ì‹¶ìœ¼ì„¸ìš”?"
6. "ëˆê³¼ ì‹œê°„ì´ ë¬´í•œí•˜ë‹¤ë©´, ë¬´ì—‡ì„ í•˜ê³  ì‹¶ìœ¼ì„¸ìš”?"

íŠ¹ë³„ ì§€ì‹œì‚¬í•­:
- ìƒˆë¡œìš´ ì§ˆë¬¸ ì‹œì‘ ì‹œ, ë°˜ë“œì‹œ ë”°ëœ»í•œ ì¸ì‚¬ì™€ í•¨ê»˜ ì§ˆë¬¸ì„ ì‹œì‘í•˜ì„¸ìš”.
- ì˜ˆ: "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ê·¸ë¦°ì´ì—ìš” ğŸŒ¿ í•¨ê»˜ ë‹¹ì‹ ì˜ ê¿ˆê³¼ ì´ìƒì„ ê·¸ë ¤ë³´ê³  ì‹¶ì–´ìš”. ì „ì§€ì „ëŠ¥í•˜ë‹¤ë©´, ì–´ë–¤ ì„¸ìƒì„ ë§Œë“¤ê³  ì‹¶ìœ¼ì„¸ìš”?"

ëŒ€í™” ì§„í–‰ ì „ëµ:
1. ì²« ë‹µë³€ í›„ â†’ êµ¬ì²´ì ì¸ ëª¨ìŠµê³¼ ìƒí™© íƒêµ¬
2. ìƒí™© íŒŒì•… í›„ â†’ ê·¸ë ‡ê²Œ í•˜ê³  ì‹¶ì€ ì´ìœ ì™€ ê°ì • íƒêµ¬
3. ê°ì • íƒêµ¬ í›„ â†’ ê·¸ ê¿ˆì´ ì£¼ëŠ” ì˜ë¯¸ ë°œê²¬

ëª°ì… íšŒë³µ ì „ëµ:
1. ê°ê°í™”: "ê·¸ ì„¸ìƒì€ ì–´ë–¤ ëŠë‚Œì¼ê¹Œìš”?"
2. ëŒ€ì²´ ê²½í—˜: "ì–´ë¦´ ë•Œ ê¿¨ë˜ ê¿ˆê³¼ ë¹„ìŠ·í•œ ë¶€ë¶„ì´ ìˆë‚˜ìš”?"
3. ìƒìƒ ì „í™˜: "ë§ˆë²•ì´ ìˆë‹¤ë©´ ì²« ë²ˆì§¸ë¡œ ë­˜ í•˜ê³  ì‹¶ì–´ìš”?"
4. ì—­í•  ë°”ê¾¸ê¸°: "ì‚¬ë‘í•˜ëŠ” ì‚¬ëŒë“¤ì„ ìœ„í•´ì„œë¼ë©´ ë­˜ í•˜ê³  ì‹¶ì–´ìš”?"
5. ë°˜ë³µ ìœ ë„: "ê·¸ ë§ˆìŒì„ í•œ ë§ˆë””ë¡œ í‘œí˜„í•œë‹¤ë©´?"

ë‹µë³€ ì™„ë£Œ íŒë‹¨:
- êµ¬ì²´ì ì¸ ê¿ˆì´ë‚˜ ì´ìƒì´ ë‚˜ì™”ê³ 
- ê·¸ë ‡ê²Œ í•˜ê³  ì‹¶ì€ ì´ìœ ê°€ ëª…í™•í•˜ê³ 
- ê·¸ ê¿ˆì´ ì£¼ëŠ” ê°ì •ì´ í‘œí˜„ë˜ì—ˆì„ ë•Œ

í™•ì¸ ë°©ì‹:
"**[ANSWER_READY]**[ê¿ˆê³¼ ì´ìƒ ìš”ì•½]ì´ ë‹¹ì‹ ì´ ì§„ì • ì›í•˜ëŠ” ê²ƒ ë§ë‚˜ìš”?**[ANSWER_READY]**"

ë§ì„¤ì„ ëŒ€ì‘:
"ì¡°ê¸ˆ ë” ìƒê°í•´ë³¼ê²Œ" ì„ íƒ ì‹œ:
"ê´œì°®ì•„ìš”. ì–´ë¦´ ë•Œ ê¿¨ë˜ ì†Œì†Œí•œ ê¿ˆì´ë¼ë„ ì¢‹ì•„ìš”. í˜¹ì‹œ 'ì´ëŸ° ì„¸ìƒì´ë©´ ì¢‹ê² ë‹¤' í•˜ê³  ìƒê°í•´ë³¸ ì  ìˆë‚˜ìš”?"

í…ŒìŠ¤íŠ¸ ëª¨ë“œ:
ì‚¬ìš©ìê°€ "í…ŒìŠ¤íŠ¸"ë¼ê³  ì…ë ¥í•˜ë©´, ë°”ë¡œ ë‹¤ìŒê³¼ ê°™ì´ ë‹µë³€í•˜ì„¸ìš”:
"**[ANSWER_READY]**ëª¨ë“  ì‚¬ëŒì´ ì„œë¡œ ì¡´ì¤‘í•˜ê³  ë°°ë ¤í•˜ëŠ” í‰í™”ë¡œìš´ ì„¸ìƒì„ ë§Œë“¤ê³  ì‹¶ë‹¤ëŠ” ê²ƒì´ ë§ë‚˜ìš”?**[ANSWER_READY]**"`
  },
  main: {
    type: 'main',
    name: 'ì§€í˜œ',
    persona: 'ë§ˆì§€ë§‰ ì§ˆë¬¸ì„ í†µí•´ ëª¨ë“  ê²ƒì„ í†µí•©í•˜ëŠ” ì§€í˜œë¡œìš´ ìƒë‹´ì‚¬',
    systemPrompt: `ë‹¹ì‹ ì€ "ì§€í˜œ"ë¼ëŠ” ì´ë¦„ì˜ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ğŸŒŸ

í•µì‹¬ ì›ì¹™:
- í•œ ë²ˆì— í•˜ë‚˜ì˜ ì§ˆë¬¸ë§Œ í•©ë‹ˆë‹¤
- ì§€ê¸ˆê¹Œì§€ì˜ ëª¨ë“  ëŒ€í™”ë¥¼ ì¢…í•©í•©ë‹ˆë‹¤
- ë”°ëœ»í•˜ê³  ì§€í˜œë¡œìš´ í†¤ìœ¼ë¡œ ë§í•©ë‹ˆë‹¤
- ë§ˆì§€ë§‰ ì§ˆë¬¸ì˜ ì¤‘ìš”ì„±ì„ ì¸ì‹í•©ë‹ˆë‹¤

í˜„ì¬ ë‹´ë‹¹ ì§ˆë¬¸:
8. "ë‹¹ì‹ ê³¼ ì„±ê²©ì´ ë¹„ìŠ·í•œ í›„ë°° ë£¸ë©”ì´íŠ¸ê°€ ìˆë‹¤ë©´, ê·¸ ì¹œêµ¬ì—ê²Œ ê¼­ í•´ì£¼ê³  ì‹¶ì€ ì¸ìƒ ì¡°ì–¸ì€?"

íŠ¹ë³„ ì§€ì‹œì‚¬í•­:
- ìƒˆë¡œìš´ ì§ˆë¬¸ ì‹œì‘ ì‹œ, ë°˜ë“œì‹œ ë”°ëœ»í•œ ì¸ì‚¬ì™€ í•¨ê»˜ ì§ˆë¬¸ì„ ì‹œì‘í•˜ì„¸ìš”.
- ì˜ˆ: "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì§€í˜œì˜ˆìš” ğŸŒŸ ì§€ê¸ˆê¹Œì§€ì˜ ëª¨ë“  ëŒ€í™”ë¥¼ í†µí•´ ë‹¹ì‹ ë§Œì˜ ì¸ìƒ ì¡°ì–¸ì„ í•¨ê»˜ ì°¾ì•„ë³´ê³  ì‹¶ì–´ìš”. ë‹¹ì‹ ê³¼ ì„±ê²©ì´ ë¹„ìŠ·í•œ í›„ë°° ë£¸ë©”ì´íŠ¸ê°€ ìˆë‹¤ë©´, ê·¸ ì¹œêµ¬ì—ê²Œ ê¼­ í•´ì£¼ê³  ì‹¶ì€ ì¸ìƒ ì¡°ì–¸ì€ ë¬´ì—‡ì¸ê°€ìš”?"

ëŒ€í™” ì§„í–‰ ì „ëµ:
1. ì²« ë‹µë³€ í›„ â†’ ê·¸ ì¡°ì–¸ì˜ êµ¬ì²´ì  ë‚´ìš©ê³¼ ì´ìœ  íƒêµ¬
2. ì´ìœ  íŒŒì•… í›„ â†’ ì™œ ê·¸ ì¡°ì–¸ì´ ì¤‘ìš”í•œì§€ ê¹Šì´ íƒêµ¬
3. ì¶©ë¶„í•œ íƒêµ¬ í›„ â†’ ë‹µë³€ í™•ì¸

ëª°ì… íšŒë³µ ì „ëµ:
1. ê°ê°í™”: "ê·¸ ì¡°ì–¸ì„ ë°›ëŠ”ë‹¤ë©´ ì–´ë–¤ ê¸°ë¶„ì¼ê¹Œìš”?"
2. ëŒ€ì²´ ê²½í—˜: "ê³¼ê±°ì˜ ë‚˜ì—ê²Œ í•´ì£¼ê³  ì‹¶ì—ˆë˜ ë§ì´ ìˆë‚˜ìš”?"
3. ìƒìƒ ì „í™˜: "ê°€ì¥ í˜ë“¤ì—ˆì„ ë•Œ ëˆ„êµ°ê°€ í•´ì¤¬ìœ¼ë©´ ì¢‹ì•˜ì„ ë§ì€?"
4. ì—­í•  ë°”ê¾¸ê¸°: "ë‹¹ì‹ ì´ ë©˜í† ë¼ë©´ ì–´ë–¤ ë§ì„ í•´ì¤„ê¹Œìš”?"
5. ë°˜ë³µ ìœ ë„: "ê·¸ ë§ˆìŒì„ ë‹´ì•„ í•œ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•œë‹¤ë©´?"

ë‹µë³€ ì™„ë£Œ íŒë‹¨:
- êµ¬ì²´ì ì¸ ì¡°ì–¸ ë‚´ìš©ì´ ë‚˜ì™”ê³ 
- ê·¸ ì¡°ì–¸ì˜ ì´ìœ ì™€ ë°°ê²½ì´ ëª…í™•í•˜ê³ 
- ì§„ì‹¬ì´ ë‹´ê¸´ ë©”ì‹œì§€ê°€ í‘œí˜„ë˜ì—ˆì„ ë•Œ

í™•ì¸ ë°©ì‹:
"**[ANSWER_READY]**[ì¡°ì–¸ ìš”ì•½]ì´ ë‹¹ì‹ ì´ ê¼­ í•´ì£¼ê³  ì‹¶ì€ ì¸ìƒ ì¡°ì–¸ ë§ë‚˜ìš”?**[ANSWER_READY]**"

ë§ì„¤ì„ ëŒ€ì‘:
"ì¡°ê¸ˆ ë” ìƒê°í•´ë³¼ê²Œ" ì„ íƒ ì‹œ:
"ì²œì²œíˆ ìƒê°í•´ë³´ì„¸ìš”. í˜¹ì‹œ ëˆ„êµ°ê°€ì—ê²Œ 'ì´ë ‡ê²Œ ì‚´ì•˜ìœ¼ë©´ ì¢‹ê² ë‹¤' í•˜ê³  ë°”ëë˜ ì ì´ ìˆë‚˜ìš”?"

í…ŒìŠ¤íŠ¸ ëª¨ë“œ:
ì‚¬ìš©ìê°€ "í…ŒìŠ¤íŠ¸"ë¼ê³  ì…ë ¥í•˜ë©´, ë°”ë¡œ ë‹¤ìŒê³¼ ê°™ì´ ë‹µë³€í•˜ì„¸ìš”:
"**[ANSWER_READY]**í•­ìƒ ë„ì „ì„ ë‘ë ¤ì›Œí•˜ì§€ ë§ê³  ìì‹ ì„ ë¯¿ìœ¼ë¼ëŠ” ì¡°ì–¸ì´ ë§ë‚˜ìš”?**[ANSWER_READY]**"`
  }
}

// 8ë‹¨ê³„ ì§ˆë¬¸ ì •ì˜ (ì •í™•í•œ ë‚´ìš©)
const counselingQuestions = [
  {
    id: 1,
    question: "ë‹¹ì‹ ì´ ê°€ì¥ ë¿Œë“¯í–ˆë˜ ê²½í—˜ì€ ë¬´ì—‡ì¸ê°€ìš”?",
    counselor: 'yellow',
    description: "ë¿Œë“¯í•¨ì„ í†µí•œ ì„±ì·¨ ê°€ì¹˜ íƒìƒ‰"
  },
  {
    id: 2,
    question: "ê°€ì¥ ë³´ëŒ ìˆì—ˆë˜ ê²½í—˜ì€ìš”?",
    counselor: 'yellow',
    description: "ë³´ëŒì„ í†µí•œ ì˜ë¯¸ ë°œê²¬"
  },
  {
    id: 3,
    question: "ì¸ìƒì—ì„œ ê°€ì¥ ì¢‹ì•˜ë˜ ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”?",
    counselor: 'bibi',
    description: "í–‰ë³µì˜ ìˆœê°„ì„ í†µí•œ ê°€ì¹˜ íƒìƒ‰"
  },
  {
    id: 4,
    question: "ê°€ì¥ ê´´ë¡œì› ë˜/í˜ë“¤ì—ˆë˜ ìˆœê°„ì€ìš”?",
    counselor: 'bibi',
    description: "ê³ ë‚œì„ í†µí•œ ì§„ì •í•œ ë°”ëŒ ë°œê²¬"
  },
  {
    id: 5,
    question: "ì „ì§€ì „ëŠ¥í•˜ë‹¤ë©´, ì–´ë–¤ ì„¸ìƒì„ ë§Œë“¤ê³  ì‹¶ìœ¼ì„¸ìš”?",
    counselor: 'green',
    description: "ì´ìƒí–¥ì„ í†µí•œ ê°€ì¹˜ê´€ íƒìƒ‰"
  },
  {
    id: 6,
    question: "ëˆê³¼ ì‹œê°„ì´ ë¬´í•œí•˜ë‹¤ë©´, ë¬´ì—‡ì„ í•˜ê³  ì‹¶ìœ¼ì„¸ìš”?",
    counselor: 'green',
    description: "ì§„ì •í•œ ìš•êµ¬ì™€ ê¿ˆ ë°œê²¬"
  },
  {
    id: 7,
    question: "ë‹¹ì‹ ì˜ ê°ì • ì¤‘ ë‚¨ì—ê²Œë„ ì „íŒŒí•˜ê³  ì‹¶ì€ ê°ì •ì€ ë¬´ì—‡ì¸ê°€ìš”?",
    counselor: 'bibi',
    description: "ì „íŒŒí•˜ê³  ì‹¶ì€ ê°ì •ì„ í†µí•œ ì‚¬ëª…ê° ë°œê²¬"
  },
  {
    id: 8,
    question: "ë‹¹ì‹ ê³¼ ì„±ê²©ì´ ë¹„ìŠ·í•œ í›„ë°° ë£¸ë©”ì´íŠ¸ê°€ ìˆë‹¤ë©´, ê·¸ ì¹œêµ¬ì—ê²Œ ê¼­ í•´ì£¼ê³  ì‹¶ì€ ì¸ìƒ ì¡°ì–¸ì€?",
    counselor: 'main',
    description: "ì¡°ì–¸ì„ í†µí•œ ì‚¶ì˜ ì§€í˜œì™€ ê°€ì¹˜ ì •ë¦¬"
  }
]

export async function POST(request: NextRequest) {
  try {
    const { sessionId, message, userId } = await request.json()

    if (!sessionId || message === undefined || !userId) {
      return NextResponse.json(
        { success: false, error: 'í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' },
        { status: 400 }
      )
    }

    // ì„¸ì…˜ ì •ë³´ ì¡°íšŒ
    const { data: session, error: sessionError } = await supabaseServer
      .from('sessions')
      .select('*')
      .eq('id', sessionId)
      .eq('user_id', userId)
      .single()

    if (sessionError || !session) {
      return NextResponse.json(
        { success: false, error: 'ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' },
        { status: 404 }
      )
    }

    // í˜„ì¬ ë‹¨ê³„ì— ë”°ë¥¸ ìƒë‹´ì‚¬ ê²°ì •
    let currentCounselorType = 'yellow' // ê¸°ë³¸ê°’ì„ ì˜ë¡œë¡œ ì„¤ì •
    
    if (session.counseling_phase === 'questions' && session.current_question_index >= 1) {
      const questionIndex = session.current_question_index - 1 // ë°°ì—´ ì¸ë±ìŠ¤ëŠ” 0ë¶€í„° ì‹œì‘
      if (questionIndex < counselingQuestions.length) {
        currentCounselorType = counselingQuestions[questionIndex].counselor
      }
    } else if (session.counseling_phase === 'why_generation' || session.counseling_phase === 'completed') {
      currentCounselorType = 'main'
    }

    const currentCounselor = counselors[currentCounselorType as keyof typeof counselors]

    // ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ìˆì„ ë•Œë§Œ ì €ì¥ (ë¹ˆ ë©”ì‹œì§€ëŠ” ì²« ì¸ì‚¬ìš©)
    if (message.trim()) {
      const { error: messageError } = await supabaseServer
        .from('messages')
        .insert({
          session_id: sessionId,
          user_id: userId,
          role: 'user',
          content: message,
          counselor_id: currentCounselorType
        })

      if (messageError) {
        console.error('ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ ì˜¤ë¥˜:', messageError)
        return NextResponse.json(
          { success: false, error: 'ë©”ì‹œì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' },
          { status: 500 }
        )
      }
    }

    // ê¸°ì¡´ ë©”ì‹œì§€ë“¤ ì¡°íšŒ (ì»¨í…ìŠ¤íŠ¸ìš©)
    const { data: previousMessages } = await supabaseServer
      .from('messages')
      .select('*')
      .eq('session_id', sessionId)
      .order('created_at', { ascending: true })
      .limit(20) // ìµœê·¼ 20ê°œ ë©”ì‹œì§€ë§Œ

    // OpenAI ë©”ì‹œì§€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    const openaiMessages = [
      {
        role: 'system' as const,
        content: currentCounselor.systemPrompt
      },
      ...(previousMessages || []).map(msg => ({
        role: msg.role as 'user' | 'assistant',
        content: msg.content
      }))
    ]

    // ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ìˆì„ ë•Œë§Œ ì¶”ê°€ (ë¹ˆ ë©”ì‹œì§€ëŠ” ì²« ì¸ì‚¬ìš©)
    if (message.trim()) {
      openaiMessages.push({
        role: 'user' as const,
        content: message
      })
    } else {
      // ë¹ˆ ë©”ì‹œì§€ì¼ ë•ŒëŠ” ì²« ì¸ì‚¬ ìš”ì²­
      openaiMessages.push({
        role: 'user' as const,
        content: 'ì•ˆë…•í•˜ì„¸ìš”! ìƒë‹´ì„ ì‹œì‘í•˜ê³  ì‹¶ì–´ìš”.'
      })
    }

    // OpenAI API í˜¸ì¶œ
    const completion = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: openaiMessages,
      temperature: 0.7,
      max_tokens: 1000,
    })

    const aiResponse = completion.choices[0]?.message?.content

    if (!aiResponse) {
      return NextResponse.json(
        { success: false, error: 'AI ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.' },
        { status: 500 }
      )
    }

    // AI ì‘ë‹µ ì €ì¥
    const { error: aiMessageError } = await supabaseServer
      .from('messages')
      .insert({
        session_id: sessionId,
        user_id: userId,
        role: 'assistant',
        content: aiResponse,
        counselor_id: currentCounselorType
      })

    if (aiMessageError) {
      console.error('AI ë©”ì‹œì§€ ì €ì¥ ì˜¤ë¥˜:', aiMessageError)
    }

    // ë‹µë³€ í™•ì¸ ì‹ í˜¸ ì²´í¬
    const hasAnswerReady = aiResponse.includes('[ANSWER_READY]')
    let shouldAdvance = false
    let nextPhaseData = null

    if (hasAnswerReady) {
      // ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰ ì •ë³´ ì¤€ë¹„
      shouldAdvance = true
      console.log('ğŸ” ë‹µë³€ í™•ì¸ ì‹ í˜¸ ê°ì§€! ë‹¤ìŒ ë‹¨ê³„ ì¤€ë¹„ ì¤‘...')
      
      if (session.counseling_phase === 'questions') {
        const currentQuestionIndex = session.current_question_index
        const nextQuestionIndex = currentQuestionIndex + 1
        
        console.log('ğŸ“Š ì§ˆë¬¸ ì¸ë±ìŠ¤:', { 
          current: currentQuestionIndex, 
          next: nextQuestionIndex,
          totalQuestions: counselingQuestions.length 
        })
        
        if (nextQuestionIndex <= 8) {
          const nextQuestion = counselingQuestions[nextQuestionIndex - 1]
          console.log('ğŸ“ ë‹¤ìŒ ì§ˆë¬¸:', nextQuestion)
          
          nextPhaseData = {
            nextPhase: 'questions',
            nextQuestionIndex,
            nextCounselor: nextQuestion.counselor,
            nextQuestion: nextQuestion.question
          }
          console.log('âœ… nextPhaseData ìƒì„± ì™„ë£Œ:', nextPhaseData)
        } else {
          // ëª¨ë“  ì§ˆë¬¸ ì™„ë£Œ - Why ìƒì„± ë‹¨ê³„ë¡œ
          nextPhaseData = {
            nextPhase: 'why_generation',
            nextQuestionIndex: 0,
            nextCounselor: 'main',
            nextQuestion: null
          }
        }
      }
    }

    return NextResponse.json({
      success: true,
      response: aiResponse,
      counselor: currentCounselor,
      shouldAdvance,
      nextPhaseData
    })

  } catch (error) {
    console.error('ì±„íŒ… API ì˜¤ë¥˜:', error)
    return NextResponse.json(
      { success: false, error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500 }
    )
  }
}